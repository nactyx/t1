# Playbook: запуск нового проекта без конфликтов
Цель: чтобы в любой момент можно было сказать «давай сделаем проект», и он стартовал предсказуемо: репозиторий, CI, автотесты, контейнеризация, деплой на VPS, документация.

## Принципы (чтобы проекты не мешали друг другу)
1) Один проект = один репозиторий.
2) Один проект = один compose stack на VPS в своей папке `/opt/apps/<project>`.
3) Проекты НЕ публикуют порты наружу (никаких `ports:`), кроме edge.
4) Внешний трафик (80/443) принимает edge (Caddy) и проксирует внутрь через docker network `edge`.
5) Секреты не коммитим. На CI и на VPS — через secrets/env.

## Стандартная структура репозитория проекта
Минимум:
- `README.md` (как запустить локально и как деплоить)
- `docs/architecture.md` (короткое описание архитектуры)
- `scripts/ci.ps1` (локальная и CI проверка)
- `.github/workflows/ci.yml` (CI)
- `ops/` (инфра/деплой артефакты проекта, если нужно)

## CI/CD (база)
### CI
Базовый pipeline:
- форматирование/линт
- тесты
- сборка (если применимо)
- артефакты (опционально)

### CD (тестовый VPS)
Модель по умолчанию:
- manual deploy (workflow_dispatch) или deploy на merge в main (решаем на проект).
- деплой выполняется через docker compose на VPS.

## Автотесты
Минимум для нового проекта:
- 1 smoke-тест (проверка запуска)
- 1 unit-тест
- (для web/API) 1 интеграционный тест HTTP

## Архитектура (кратко и полезно)
Шаблон файла: `docs/architecture.md`.
Содержимое:
- назначение и границы системы
- основные компоненты
- хранилища/очереди (если есть)
- API/контракты
- окружения (dev/test/prod)
- риски и решения

## Контейнеризация (Docker)
Для проекта готовим:
- `Dockerfile`
- `docker-compose.yml` без публикации портов наружу
- подключение к внешней сети `edge`

Правило:
- если нужно HTTP — приложение слушает 80 внутри контейнера (или документируем порт) и edge проксирует.

## Деплой на VPS (боевой шаблон)
Инварианты:
- edge stack: `/opt/t1/edge` (Caddy+TLS)
- проекты: `/opt/apps/<project>`
- общая сеть: docker network `edge` (external)

Процесс:
1) Создаём папку проекта в репо (например `ops/vps/apps/<project>`).
2) Деплоим на VPS в `/opt/apps/<project>` через `scripts/deploy-vps.ps1`.
3) Добавляем routing в `ops/vps/edge/Caddyfile`:
   - path-based (например `/myapp/*`)
   - или отдельный субдомен (рекомендовано для «боевых» сервисов)
4) Перезапускаем edge: `cd /opt/t1/edge && docker compose up -d`.

## Что я делаю автоматически (рутина)
По запросу «сделай проект <name>» я по умолчанию:
- создаю/инициализирую репозиторий из шаблона `t1`
- добавляю структуру и минимальные проверки
- настраиваю CI
- готовлю docker-compose для деплоя за edge
- обновляю документацию (в репо и в `OneDrive/Projects/nactyx-infra.md`)

## Что считается критичным (буду спрашивать короткое подтверждение)
- изменения доступа: SSH/firewall/порты
- установка/удаление системных пакетов/сервисов на VPS
- изменения edge routing, которые могут положить существующие домены
- миграции/операции с данными
- продакшн-деплой (когда появится prod)
